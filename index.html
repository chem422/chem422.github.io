<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Upload & Download</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #uploadModal, #gameDetailsModal {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #uploadModal.open, #gameDetailsModal.open {
            display: flex;
            opacity: 1;
        }
        .game-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Game Platform</h1>
            <div class="text-sm">Upload & Share Your Games</div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto p-6">
        <!-- Upload Button -->
        <div class="flex justify-center mb-8">
            <button id="openUploadModal" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition duration-200">Upload Games</button>
        </div>

        <!-- Games Grid -->
        <div id="gamesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl w-full max-w-lg shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Upload Your Games</h2>
            <form id="uploadForm">
                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Game Files (.exe or .html, max 25MB for GitHub hosting)</label>
                    <input type="file" id="gameFiles" accept=".exe,.html" multiple class="mt-1 block w-full border-gray-300 rounded-md p-2 border">
                </div>
                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Icon (.png)</label>
                    <input type="file" id="gameIcon" accept=".png" class="mt-1 block w-full border-gray-300 rounded-md p-2 border">
                </div>
                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                    <input type="text" id="gameTitle" class="mt-1 block w-full border-gray-300 rounded-md p-2 border" required>
                </div>
                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="gameDescription" class="mt-1 block w-full border-gray-300 rounded-md p-2 border" rows="4" required></textarea>
                </div>
                <div class="flex justify-end items-center">
                    <button type="button" id="closeUploadModal" class="mr-3 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="uploadButton" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center">
                        <span>Load</span>
                        <div id="uploadSpinner" class="spinner ml-2"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Game Details Modal -->
    <div id="gameDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl w-full max-w-lg shadow-2xl">
            <h2 id="detailsTitle" class="text-2xl font-bold mb-4 text-gray-800"></h2>
            <img id="detailsIcon" class="w-40 h-40 object-cover mb-4 rounded mx-auto" alt="Game Icon">
            <p id="detailsDescription" class="text-gray-600 mb-6"></p>
            <div class="flex justify-between mb-4">
                <a id="detailsDownload" href="#" download class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600" title="Download the game file">Download</a>
                <button id="detailsPlay" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Play in Browser</button>
            </div>
            <div class="flex justify-between">
                <button id="deleteGame" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Delete Game</button>
                <button id="closeDetailsModal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Simulated storage for games
        let games = JSON.parse(localStorage.getItem('games')) || [];

        // Function to display games
        function displayGames() {
            try {
                const gamesGrid = document.getElementById('gamesGrid');
                gamesGrid.innerHTML = '';
                games.forEach((game, index) => {
                    const gameCard = document.createElement('div');
                    gameCard.className = 'game-card bg-white p-5 rounded-xl shadow-lg cursor-pointer relative';
                    gameCard.innerHTML = `
                        <img src="${game.icon}" alt="${game.title}" class="w-32 h-32 object-cover mx-auto mb-3 rounded-lg">
                        <h3 class="text-lg font-semibold text-center text-gray-800">${game.title}</h3>
                        <button class="delete-game absolute top-2 right-2 text-red-500 hover:text-red-700" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    gameCard.querySelector('.delete-game').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteGame(index);
                    });
                    gameCard.addEventListener('click', (e) => {
                        if (!e.target.closest('.delete-game')) showGameDetails(index);
                    });
                    gamesGrid.appendChild(gameCard);
                });
            } catch (error) {
                console.error('Error displaying games:', error);
                alert('Failed to display games. Please try again.');
            }
        }

        // Delete game
        function deleteGame(index) {
            try {
                if (confirm('Are you sure you want to delete this game?')) {
                    games.splice(index, 1);
                    localStorage.setItem('games', JSON.stringify(games));
                    displayGames();
                    document.getElementById('gameDetailsModal').classList.remove('open');
                }
            } catch (error) {
                console.error('Error deleting game:', error);
                alert('Failed to delete game. Please try again.');
            }
        }

        // Open upload modal
        document.getElementById('openUploadModal').addEventListener('click', () => {
            try {
                document.getElementById('uploadModal').classList.add('open');
            } catch (error) {
                console.error('Error opening upload modal:', error);
                alert('Failed to open upload modal. Please try again.');
            }
        });

        // Close upload modal
        document.getElementById('closeUploadModal').addEventListener('click', () => {
            try {
                document.getElementById('uploadModal').classList.remove('open');
                document.getElementById('uploadForm').reset();
            } catch (error) {
                console.error('Error closing upload modal:', error);
                alert('Failed to close upload modal. Please try again.');
            }
        });

        // Handle form submission
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uploadButton = document.getElementById('uploadButton');
            const uploadSpinner = document.getElementById('uploadSpinner');
            uploadButton.disabled = true;
            uploadSpinner.style.display = 'block';

            try {
                const gameFiles = document.getElementById('gameFiles').files;
                const gameIcon = document.getElementById('gameIcon').files[0];
                const gameTitle = document.getElementById('gameTitle').value.trim();
                const gameDescription = document.getElementById('gameDescription').value.trim();

                if (gameFiles.length === 0 || !gameIcon || !gameTitle || !gameDescription) {
                    alert('Please fill in all fields and select at least one game file (.exe or .html) and a .png icon.');
                    uploadButton.disabled = false;
                    uploadSpinner.style.display = 'none';
                    return;
                }

                // Validate file types and size (25MB limit for GitHub)
                for (let i = 0; i < gameFiles.length; i++) {
                    const file = gameFiles[i];
                    if (!['text/html', 'application/x-msdownload'].includes(file.type) && !file.name.endsWith('.exe') && !file.name.endsWith('.html')) {
                        alert(`Invalid file type for ${file.name}. Only .exe and .html files are allowed.`);
                        uploadButton.disabled = false;
                        uploadSpinner.style.display = 'none';
                        return;
                    }
                    if (file.size > 25 * 1024 * 1024) {
                        alert(`File ${file.name} exceeds 25MB, which is GitHub's limit for web uploads.`);
                        uploadButton.disabled = false;
                        uploadSpinner.style.display = 'none';
                        return;
                    }
                }
                if (gameIcon.type !== 'image/png') {
                    alert('Invalid icon file type. Only .png files are allowed.');
                    uploadButton.disabled = false;
                    uploadSpinner.style.display = 'none';
                    return;
                }

                const readerIcon = new FileReader();
                readerIcon.onload = async () => {
                    try {
                        const iconData = readerIcon.result;
                        for (let i = 0; i < gameFiles.length; i++) {
                            const gameFile = gameFiles[i];
                            // Placeholder GitHub URL (replace with actual API upload result)
                            const downloadUrl = `https://raw.githubusercontent.com/your-username/game-platform-files/main/uploads/${gameFile.name}`;
                            /*
                            To upload to GitHub, use the API:
                            - Get a Personal Access Token (PAT) with 'repo' scope.
                            - Send a PUT request to /repos/{owner}/{repo}/contents/uploads/{file.name}
                            - Body: { "message": "Upload game file", "content": base64(file) }
                            - Example:
                              const response = await fetch('https://api.github.com/repos/your-username/game-platform-files/contents/uploads/${gameFile.name}', {
                                method: 'PUT',
                                headers: {
                                  'Authorization': 'Bearer YOUR_PAT',
                                  'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                  message: 'Upload game file',
                                  content: btoa(await gameFile.text()) // Base64 encode
                                })
                              });
                              const downloadUrl = response.json().content.download_url;
                            Note: Exposing PAT in client-side code is insecure. Use a backend proxy.
                            */
                            if (gameFile.type === 'text/html' && gameFile.size < 1024 * 1024) {
                                const readerFile = new FileReader();
                                await new Promise((resolve, reject) => {
                                    readerFile.onload = () => {
                                        games.push({
                                            title: gameTitle,
                                            description: gameDescription,
                                            icon: iconData,
                                            file: gameFile.name,
                                            content: readerFile.result,
                                            downloadUrl
                                        });
                                        resolve();
                                    };
                                    readerFile.onerror = () => reject(new Error(`Failed to read file: ${gameFile.name}`));
                                    readerFile.readAsDataURL(gameFile);
                                });
                            } else {
                                games.push({
                                    title: gameTitle,
                                    description: gameDescription,
                                    icon: iconData,
                                    file: gameFile.name,
                                    downloadUrl
                                });
                            }
                        }
                        localStorage.setItem('games', JSON.stringify(games));
                        displayGames();
                        document.getElementById('uploadModal').classList.remove('open');
                        document.getElementById('uploadForm').reset();
                    } catch (error) {
                        console.error('Error processing upload:', error);
                        alert('Failed to upload games. Please try again.');
                    } finally {
                        uploadButton.disabled = false;
                        uploadSpinner.style.display = 'none';
                    }
                };
                readerIcon.onerror = () => {
                    alert('Failed to read icon file. Please select a valid .png file.');
                    uploadButton.disabled = false;
                    uploadSpinner.style.display = 'none';
                };
                readerIcon.readAsDataURL(gameIcon);
            } catch (error) {
                console.error('Error during upload:', error);
                alert('An error occurred during upload. Please try again.');
                uploadButton.disabled = false;
                uploadSpinner.style.display = 'none';
            }
        });

        // Show game details
        function showGameDetails(index) {
            try {
                const game = games[index];
                document.getElementById('detailsTitle').textContent = game.title;
                document.getElementById('detailsIcon').src = game.icon;
                document.getElementById('detailsDescription').textContent = game.description;
                document.getElementById('detailsDownload').href = game.downloadUrl || '#';
                document.getElementById('detailsDownload').onclick = (e) => {
                    if (!game.downloadUrl) {
                        e.preventDefault();
                        alert('Download not available: File must be uploaded to GitHub repository.');
                    }
                };
                document.getElementById('detailsPlay').onclick = () => {
                    if (game.content && game.file.endsWith('.html')) {
                        try {
                            const newTab = window.open();
                            if (newTab) {
                                newTab.document.write(game.content.replace('data:text/html;base64,', 'data:text/html;charset=utf-8,'));
                            } else {
                                alert('Failed to open new tab. Please allow pop-ups and try again.');
                            }
                        } catch (error) {
                            console.error('Error playing HTML game:', error);
                            alert('Failed to play game in browser. Please try again.');
                        }
                    } else {
                        alert('Playing .exe files in the browser is not supported. Please download the game to play.');
                    }
                };
                document.getElementById('deleteGame').onclick = () => deleteGame(index);
                document.getElementById('gameDetailsModal').classList.add('open');
            } catch (error) {
                console.error('Error showing game details:', error);
                alert('Failed to show game details. Please try again.');
            }
        }

        // Close game details modal
        document.getElementById('closeDetailsModal').addEventListener('click', () => {
            try {
                document.getElementById('gameDetailsModal').classList.remove('open');
            } catch (error) {
                console.error('Error closing details modal:', error);
                alert('Failed to close details modal. Please try again.');
            }
        });

        // Initial display of games
        displayGames();
    </script>
</body>
</html>
